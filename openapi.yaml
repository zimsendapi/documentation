openapi: 3.0.3
info:
  title: ZimSend API
  version: 1.0.0
  description: |
    # Bienvenue sur l'API ZimSend

    ZimSend est une API SMS qui vous permet d'envoyer des SMS depuis vos applications en utilisant votre propre t√©l√©phone Android comme gateway.

    ## Pourquoi ZimSend ?

    - **√âconomique** : Pas de frais par SMS, utilisez votre forfait mobile
    - **Simple** : API REST facile √† int√©grer
    - **Fiable** : Webhooks, retry automatique, file d'attente
    - **Flexible** : Support de plusieurs devices, envoi programm√©, OTP int√©gr√©

    ## D√©marrage rapide

    1. Cr√©ez un compte sur [app.zimsend.com](https://app.zimsend.com)
    2. G√©n√©rez une cl√© API
    3. Connectez votre t√©l√©phone Android
    4. Commencez √† envoyer des SMS via l'API

    ## Authentification

    Toutes les requ√™tes API n√©cessitent 3 headers :
    - `X-API-Key` : Votre cl√© API
    - `X-Client-ID` : Votre identifiant client
    - `X-Device-ID` : L'ID du device Android √† utiliser

  contact:
    name: Support ZimSend
    email: support@zimsend.com
    url: https://zimsend.com/support
  license:
    name: Proprietary
    url: https://zimsend.com/terms

servers:
  - url: https://api.zimsend.com/v1
    description: Production
  - url: http://localhost:5040/v1
    description: D√©veloppement local (si applicable)

tags:
  - name: SMS
    description: Envoi et gestion des SMS
  - name: OTP
    description: Codes de v√©rification √† usage unique
  - name: Webhooks
    description: Configuration des webhooks pour recevoir des √©v√©nements
  - name: Account
    description: Gestion de votre compte (via dashboard uniquement)

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Cl√© API g√©n√©r√©e depuis le dashboard ZimSend

    ClientIdHeader:
      type: apiKey
      in: header
      name: X-Client-ID
      description: Votre identifiant client unique (visible dans le dashboard)

    DeviceIdHeader:
      type: apiKey
      in: header
      name: X-Device-ID
      description: ID du device Android √† utiliser pour l'envoi

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: "Invalid API key"
        code:
          type: string
          example: "INVALID_API_KEY"
        details:
          type: object

    SmsMessage:
      type: object
      properties:
        message_id:
          type: string
          example: "msg_abc123xyz"
          description: Identifiant unique du message
        to:
          type: string
          example: "+33612345678"
          description: Num√©ro du destinataire
        message:
          type: string
          example: "Votre code de v√©rification est 123456"
        status:
          type: string
          enum: [queued, processing, sent, delivered, failed]
          example: "delivered"
        priority:
          type: integer
          minimum: 1
          maximum: 5
          default: 3
          example: 3
          description: "Priorit√© d'envoi du SMS : 1=tr√®s haute (urgent), 2=haute, 3=normale (par d√©faut), 4=basse, 5=tr√®s basse"
        device_id:
          type: string
          example: "dev_xyz789"
        queued_at:
          type: string
          format: date-time
        sent_at:
          type: string
          format: date-time
          nullable: true
        delivered_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          type: object
          additionalProperties: true

paths:
  /sms/send:
    post:
      tags:
        - SMS
      summary: Envoyer un SMS
      description: |
        Envoie un SMS unique via votre device Android.

        **Pr√©requis** :
        - Avoir un device Android connect√©
        - Headers d'authentification valides

        Le SMS sera mis en file d'attente et envoy√© d√®s que possible.
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
          DeviceIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - to
                - message
              properties:
                to:
                  type: string
                  description: Num√©ro du destinataire au format international (avec +)
                  example: "+33612345678"
                message:
                  type: string
                  minLength: 1
                  maxLength: 1000
                  description: Contenu du SMS (max 1000 caract√®res)
                  example: "Votre code de v√©rification est 123456"
                priority:
                  type: integer
                  minimum: 1
                  maximum: 5
                  default: 3
                  description: "Priorit√© d'envoi du SMS : 1=tr√®s haute (urgent), 2=haute, 3=normale (par d√©faut), 4=basse, 5=tr√®s basse"
                  example: 3
                webhook_url:
                  type: string
                  format: uri
                  description: URL pour recevoir les √©v√©nements de ce SMS
                  example: "https://votre-app.com/webhook/sms"
                metadata:
                  type: object
                  additionalProperties: true
                  description: M√©tadonn√©es personnalis√©es (max 10 cl√©s)
                  example:
                    user_id: "user_123"
                    campaign: "welcome"
                scheduled_at:
                  type: string
                  format: date-time
                  description: Date/heure d'envoi programm√© (optionnel)
                  example: "2024-12-31T23:59:59Z"
                retry_attempts:
                  type: integer
                  minimum: 1
                  maximum: 5
                  default: 3
                  description: Nombre de tentatives en cas d'√©chec
                  example: 3
            examples:
              simple:
                summary: SMS simple
                value:
                  to: "+33612345678"
                  message: "Bonjour depuis ZimSend !"
              with_priority:
                summary: SMS avec priorit√© haute
                value:
                  to: "+33612345678"
                  message: "Alerte importante : votre compte a √©t√© modifi√©"
                  priority: 5
              with_metadata:
                summary: SMS avec m√©tadonn√©es
                value:
                  to: "+33612345678"
                  message: "Votre commande #12345 est confirm√©e"
                  metadata:
                    order_id: "12345"
                    customer_id: "cust_789"
      responses:
        '202':
          description: SMS mis en file d'attente avec succ√®s
          content:
            application/json:
              schema:
                type: object
                properties:
                  message_id:
                    type: string
                    example: "msg_abc123xyz"
                  status:
                    type: string
                    example: "queued"
                  queued_at:
                    type: string
                    format: date-time
                  priority:
                    type: integer
                    example: 3
                  device_id:
                    type: string
                    example: "dev_xyz789"
        '400':
          description: Param√®tres invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Authentification invalide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Invalid API key"
                code: "INVALID_API_KEY"
        '429':
          description: Limite de quota atteinte
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Daily SMS limit reached"
                code: "QUOTA_EXCEEDED"

  /sms/send-bulk:
    post:
      tags:
        - SMS
      summary: Envoyer des SMS en masse
      description: |
        Envoie plusieurs SMS en une seule requ√™te.

        **Limites** :
        - Maximum 1000 messages par requ√™te
        - Tous les messages utilisent le m√™me device
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
          DeviceIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - messages
              properties:
                messages:
                  type: array
                  minItems: 1
                  maxItems: 1000
                  items:
                    type: object
                    required:
                      - to
                      - message
                    properties:
                      to:
                        type: string
                        example: "+33612345678"
                      message:
                        type: string
                        example: "Votre message ici"
                      metadata:
                        type: object
                        additionalProperties: true
                      priority:
                        type: integer
                        minimum: 1
                        maximum: 5
                        description: "Priorit√© d'envoi du SMS : 1=tr√®s haute (urgent), 2=haute, 3=normale (par d√©faut), 4=basse, 5=tr√®s basse"
                priority:
                  type: integer
                  minimum: 1
                  maximum: 5
                  default: 3
                  description: "Priorit√© par d√©faut pour tous les messages : 1=tr√®s haute (urgent), 2=haute, 3=normale (par d√©faut), 4=basse, 5=tr√®s basse"
                webhook_url:
                  type: string
                  format: uri
            examples:
              marketing:
                summary: Campagne marketing
                value:
                  messages:
                    - to: "+33612345678"
                      message: "üéâ Promo -20% ce weekend !"
                    - to: "+33698765432"
                      message: "üéâ Promo -20% ce weekend !"
                    - to: "+33687654321"
                      message: "üéâ Promo -20% ce weekend !"
                  priority: 2
                  webhook_url: "https://votre-app.com/webhook"
      responses:
        '202':
          description: Messages mis en file d'attente
          content:
            application/json:
              schema:
                type: object
                properties:
                  batch_id:
                    type: string
                    example: "batch_abc123"
                  total_messages:
                    type: integer
                    example: 100
                  queued_messages:
                    type: integer
                    example: 100
                  failed_messages:
                    type: integer
                    example: 0
                  message_ids:
                    type: array
                    items:
                      type: string
                    example: ["msg_1", "msg_2", "msg_3"]

  /sms/send-otp:
    post:
      tags:
        - OTP
      summary: G√©n√©rer et envoyer un code OTP
      description: |
        G√©n√®re un code de v√©rification unique et l'envoie par SMS.

        Le code est stock√© temporairement et peut √™tre v√©rifi√© avec `/sms/verify-otp`.

        **Cas d'usage** :
        - Authentification 2FA
        - V√©rification de num√©ro de t√©l√©phone
        - R√©initialisation de mot de passe
        - Validation de transaction
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
          DeviceIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - to
                - purpose
              properties:
                to:
                  type: string
                  description: Num√©ro de t√©l√©phone du destinataire
                  example: "+33612345678"
                purpose:
                  type: string
                  enum: [verification, login, transaction, registration]
                  description: Type de v√©rification
                  example: "verification"
                code_length:
                  type: integer
                  minimum: 4
                  maximum: 8
                  default: 6
                  description: Longueur du code OTP
                  example: 6
                expiry_minutes:
                  type: integer
                  minimum: 1
                  maximum: 30
                  default: 10
                  description: Dur√©e de validit√© en minutes
                  example: 10
                template:
                  type: string
                  description: "Template personnalis√© (utilisez {code} pour le code)"
                  example: "Votre code ZimSend est {code}. Valide 10 min."
                webhook_url:
                  type: string
                  format: uri
            examples:
              2fa:
                summary: Authentification 2FA
                value:
                  to: "+33612345678"
                  purpose: "login"
                  code_length: 6
                  expiry_minutes: 5
              verification:
                summary: V√©rification de num√©ro
                value:
                  to: "+33612345678"
                  purpose: "verification"
                  template: "Votre code de v√©rification est {code}"
      responses:
        '202':
          description: OTP g√©n√©r√© et SMS en file d'attente
          content:
            application/json:
              schema:
                type: object
                properties:
                  otp_id:
                    type: string
                    example: "otp_abc123"
                    description: ID de l'OTP pour la v√©rification
                  message_id:
                    type: string
                    example: "msg_xyz789"
                  expires_at:
                    type: string
                    format: date-time
                  phone_masked:
                    type: string
                    example: "+336****5678"
                    description: Num√©ro masqu√© pour affichage
                  code_length:
                    type: integer
                    example: 6

  /sms/verify-otp:
    post:
      tags:
        - OTP
      summary: V√©rifier un code OTP
      description: |
        V√©rifie qu'un code OTP est valide et non expir√©.

        **Important** : Un code OTP ne peut √™tre v√©rifi√© qu'une seule fois.
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - otp_id
                - code
              properties:
                otp_id:
                  type: string
                  description: ID de l'OTP re√ßu lors de l'envoi
                  example: "otp_abc123"
                code:
                  type: string
                  minLength: 4
                  description: Code OTP √† v√©rifier
                  example: "123456"
                phone:
                  type: string
                  description: Num√©ro de t√©l√©phone (optionnel, pour s√©curit√© suppl√©mentaire)
                  example: "+33612345678"
      responses:
        '200':
          description: V√©rification r√©ussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "OTP verified successfully"
                  verified_at:
                    type: string
                    format: date-time
        '400':
          description: Code invalide ou expir√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Invalid or expired OTP"
                  code:
                    type: string
                    example: "INVALID_OTP"

  /sms/status/{message_id}:
    get:
      tags:
        - SMS
      summary: Obtenir le statut d'un SMS
      description: R√©cup√®re les d√©tails et le statut actuel d'un SMS envoy√©
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      parameters:
        - name: message_id
          in: path
          required: true
          schema:
            type: string
          example: "msg_abc123"
      responses:
        '200':
          description: Statut du message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SmsMessage'

  /sms/history:
    get:
      tags:
        - SMS
      summary: Historique des SMS
      description: Liste pagin√©e de tous vos SMS envoy√©s avec filtres
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          example: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          example: 50
        - name: status
          in: query
          schema:
            type: string
            enum: [queued, processing, sent, delivered, failed]
          example: "delivered"
        - name: device_id
          in: query
          schema:
            type: string
          example: "dev_xyz789"
        - name: from_date
          in: query
          schema:
            type: string
            format: date-time
          example: "2024-01-01T00:00:00Z"
        - name: to_date
          in: query
          schema:
            type: string
            format: date-time
          example: "2024-12-31T23:59:59Z"
      responses:
        '200':
          description: Liste des messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/SmsMessage'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                      limit:
                        type: integer
                      total:
                        type: integer
                      pages:
                        type: integer

  /sms/{message_id}/resend:
    post:
      tags:
        - SMS
      summary: Renvoyer un SMS √©chou√©
      description: Remet en file d'attente un SMS qui a √©chou√©
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      parameters:
        - name: message_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '202':
          description: SMS remis en file d'attente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message_id:
                    type: string
                  status:
                    type: string
                    example: "queued"

  /sms/{message_id}:
    delete:
      tags:
        - SMS
      summary: Annuler un SMS programm√©
      description: Annule un SMS qui n'a pas encore √©t√© envoy√©
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      parameters:
        - name: message_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: SMS annul√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  message_id:
                    type: string
                  status:
                    type: string
                    example: "cancelled"

  /webhooks/configure:
    post:
      tags:
        - Webhooks
      summary: Configurer un webhook
      description: |
        Configure une URL pour recevoir des notifications d'√©v√©nements.

        **√âv√©nements disponibles** :
        - `sms.sent` - SMS envoy√© par le device
        - `sms.delivered` - SMS livr√© avec succ√®s
        - `sms.failed` - √âchec d'envoi
        - `device.connected` - Device connect√©
        - `device.disconnected` - Device d√©connect√©

        **S√©curit√©** : Chaque webhook inclut une signature HMAC dans le header `X-Webhook-Signature`
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
                - events
              properties:
                url:
                  type: string
                  format: uri
                  description: URL de votre endpoint webhook (doit √™tre HTTPS en production)
                  example: "https://votre-app.com/webhook"
                events:
                  type: array
                  minItems: 1
                  items:
                    type: string
                  example: ["sms.sent", "sms.delivered", "sms.failed"]
                secret:
                  type: string
                  description: Cl√© secr√®te personnalis√©e (g√©n√©r√©e auto si non fournie)
      responses:
        '200':
          description: Webhook configur√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhook_id:
                    type: string
                    example: "wh_abc123"
                  url:
                    type: string
                    example: "https://votre-app.com/webhook"
                  events:
                    type: array
                    items:
                      type: string
                  secret:
                    type: string
                    description: "IMPORTANT : Sauvegardez cette cl√©, elle ne sera plus affich√©e"
                    example: "whsec_xxxxxxxxxxxxxxxx"
                  status:
                    type: string
                    example: "active"

  /webhooks:
    get:
      tags:
        - Webhooks
      summary: Liste des webhooks
      description: R√©cup√®re tous vos webhooks configur√©s
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      responses:
        '200':
          description: Liste des webhooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhooks:
                    type: array
                    items:
                      type: object
                      properties:
                        webhook_id:
                          type: string
                        url:
                          type: string
                        events:
                          type: array
                          items:
                            type: string
                        status:
                          type: string
                        created_at:
                          type: string
                          format: date-time

  /webhooks/logs:
    get:
      tags:
        - Webhooks
      summary: Logs des webhooks
      description: Historique des appels webhook avec statuts de r√©ponse
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Logs des webhooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        log_id:
                          type: string
                        webhook_id:
                          type: string
                        event:
                          type: string
                        url:
                          type: string
                        response_status:
                          type: integer
                        response_time_ms:
                          type: integer
                        success:
                          type: boolean
                        attempt:
                          type: integer
                        timestamp:
                          type: string
                          format: date-time

  /webhooks/{webhook_id}/test:
    post:
      tags:
        - Webhooks
      summary: Tester un webhook
      description: Envoie un √©v√©nement de test √† votre webhook
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      parameters:
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Test envoy√©
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Test webhook sent successfully"
                  response_status:
                    type: integer
                    example: 200

  /webhooks/{webhook_id}:
    delete:
      tags:
        - Webhooks
      summary: Supprimer un webhook
      description: Supprime un webhook configur√©
      security:
        - ApiKeyAuth: []
          ClientIdHeader: []
      parameters:
        - name: webhook_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Webhook supprim√©
